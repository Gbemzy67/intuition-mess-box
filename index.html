<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Intuition Chat</title>

<style>
* { box-sizing: border-box; font-family: system-ui, sans-serif; }

body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at right, #0b3b3f, #000);
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-wrapper {
  width: 100%;
  max-width: 380px;
  height: 90vh;
  max-height: 620px;
  background: rgba(15, 25, 30, 0.75);
  border-radius: 24px;
  backdrop-filter: blur(20px);
  display: flex;
  flex-direction: column;
  padding: 16px;
  position: relative;
}

.chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: white;
  font-weight: 600;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-circle {
  width: 28px;
  height: 28px;
  border: 3px solid white;
  border-radius: 50%;
}

.connect-btn {
  padding: 6px 12px;
  border-radius: 12px;
  border: none;
  background: #0a84ff;
  color: white;
  font-size: 12px;
  cursor: pointer;
}

.chat-body {
  flex: 1;
  padding: 16px 0;
  overflow-y: auto;
}

.message {
  display: flex;
  margin-bottom: 14px;
}

.message.right { justify-content: flex-end; }

.avatar {
  width: 34px;
  height: 34px;
  background: linear-gradient(135deg, #7b5cff, #4b2cff);
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
}

.bubble {
  max-width: 70%;
  padding: 12px 16px;
  background: rgba(255,255,255,0.08);
  color: white;
  border-radius: 18px;
}

.message.right .bubble { background: rgba(255,255,255,0.12); }

.time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 4px;
}

.chat-input {
  display: flex;
  gap: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.chat-input input {
  flex: 1;
  padding: 12px 14px;
  border-radius: 18px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.08);
  color: white;
}

.chat-input button {
  padding: 12px 18px;
  border-radius: 18px;
  border: none;
  background: linear-gradient(135deg, #0a84ff, #005eff);
  color: white;
  cursor: pointer;
}

.subscribe-popup {
  position: absolute;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(20,30,40,0.9);
  padding: 12px 16px;
  border-radius: 16px;
  display: flex;
  gap: 10px;
  flex-direction: column;
  color: white;
  z-index: 10;
}

.subscribe-popup button {
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
}

.monthly { background: #0a84ff; }
.yearly { background: #005eff; }
</style>
</head>

<body>

<div class="chat-wrapper">
  <div class="chat-header">
    <div class="header-left">
      <div class="logo-circle"></div>
      <span>INTUITION</span>
    </div>
    <button class="connect-btn" id="connectBtn">Connect Wallet</button>
  </div>

  <div class="chat-body" id="chatBody"></div>

  <div class="chat-input">
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL = "http://localhost:3000";
const TREASURY_ADDRESS = "0x7738c4cf6F513898fBa4099A6732d1E6314eB912";
const ADMIN_WALLET = TREASURY_ADDRESS.toLowerCase();
const MONTHLY_PRICE = 50;
const YEARLY_PRICE = 150;

/* ================= GLOBALS ================= */
const chatBody = document.getElementById("chatBody");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const connectBtn = document.getElementById("connectBtn");

let provider, signer, userAddress;
let subscribed = false;

/* ================= HELPERS ================= */
function time() { return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); }
function addMessage(side,text) {
  const msg=document.createElement("div");
  msg.className="message "+side;
  if(side==="left"){ const avatar=document.createElement("div"); avatar.className="avatar"; avatar.textContent="I"; msg.appendChild(avatar); }
  const bubble=document.createElement("div");
  bubble.className="bubble";
  bubble.innerHTML=`${text}<div class="time">${time()}</div>`;
  msg.appendChild(bubble);
  chatBody.appendChild(msg);
  chatBody.scrollTop=chatBody.scrollHeight;
}

/* ================= INITIAL MESSAGE ================= */
addMessage("left","üëã Welcome to Intuition Support. Connect your wallet to start.");

/* ================= MULTI-WALLET CONNECT ================= */
async function connectWallet() {
  try {
    // 1Ô∏è‚É£ Browser wallet (MetaMask, Coinbase, etc)
    if(window.ethereum){
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
    } else { addMessage("left","‚ùå No compatible wallet found."); return; }

    signer = await provider.getSigner();
    userAddress = (await signer.getAddress()).toLowerCase();
    connectBtn.textContent = userAddress.slice(0,6)+"..."+userAddress.slice(-4);
    addMessage("left","üîó Wallet connected.");
    await checkSubscription();

  } catch(e) { console.error(e); addMessage("left","‚ö†Ô∏è Wallet connection failed."); }
}

connectBtn.onclick = connectWallet;

/* ================= CHECK SUBSCRIPTION ================= */
async function checkSubscription(){
  if(userAddress===ADMIN_WALLET){ subscribed=true; addMessage("left","üëë Admin access granted. You can chat freely."); return; }
  try {
    const res=await fetch(`${BACKEND_URL}/access/${userAddress}`);
    if(res.ok){ const data=await res.json(); subscribed=data.access; if(subscribed) addMessage("left","‚úÖ Subscription active. You can chat freely."); else showSubscribePopup(); }
    else showSubscribePopup();
  } catch(e){ console.error(e); showSubscribePopup(); }
}

/* ================= SUBSCRIBE POPUP ================= */
function showSubscribePopup(){
  if(document.getElementById("subscribePopup")) return;
  const popup=document.createElement("div");
  popup.id="subscribePopup";
  popup.className="subscribe-popup";
  popup.innerHTML=`<span>üîí Subscribe to unlock premium support:</span>`;

  const monthlyBtn=document.createElement("button");
  monthlyBtn.className="monthly";
  monthlyBtn.textContent=`Monthly - ${MONTHLY_PRICE} $TRUST`;
  monthlyBtn.onclick=()=>paySubscription(MONTHLY_PRICE);

  const yearlyBtn=document.createElement("button");
  yearlyBtn.className="yearly";
  yearlyBtn.textContent=`Yearly - ${YEARLY_PRICE} $TRUST`;
  yearlyBtn.onclick=()=>paySubscription(YEARLY_PRICE);

  popup.appendChild(monthlyBtn);
  popup.appendChild(yearlyBtn);
  document.querySelector(".chat-wrapper").appendChild(popup);
}

/* ================= PAY SUBSCRIPTION ================= */
async function paySubscription(amount){
  try{
    addMessage("left","üí≥ Confirm payment in wallet...");
    const trust=new ethers.Contract(
      "0xTRUST_TOKEN_ADDRESS", // replace with real $TRUST token
      ["function transfer(address,uint256) returns (bool)"],
      signer
    );
    const tx=await trust.transfer(TREASURY_ADDRESS,ethers.parseUnits(amount.toString(),18));
    await tx.wait();
    subscribed=true;
    addMessage("left","‚úÖ Subscription successful!");
    const popup=document.getElementById("subscribePopup");
    if(popup) popup.remove();
  } catch(e){ console.error(e); addMessage("left","‚ùå Payment failed or rejected."); }
}

/* ================= SEND MESSAGE ================= */
sendBtn.onclick=async ()=>{
  const text=input.value.trim();
  if(!text) return;

  // AI greeting/pricing only
  if(/hello/i.test(text)){ addMessage("left","Hello! Ask about Intuition features or subscriptions."); input.value=""; return; }
  if(/price/i.test(text)){ addMessage("left",`Monthly: ${MONTHLY_PRICE} $TRUST, Yearly: ${YEARLY_PRICE} $TRUST.`); input.value=""; return; }
  if(/subscribe/i.test(text)){ showSubscribePopup(); input.value=""; return; }

  addMessage("right",text);
  input.value="";
  if(!subscribed) showSubscribePopup();

  // Send to backend for real answers
  try{ await fetch(`${BACKEND_URL}/message`,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({wallet:userAddress,content:text}) }); }
  catch(e){ console.error(e); }
};

/* ================= POLLING BACKEND FOR RESPONSES ================= */
setInterval(async()=>{
  if(!userAddress) return;
  try{
    const res=await fetch(`${BACKEND_URL}/conversation/${userAddress}`);
    const msgs=await res.json();
    chatBody.innerHTML="";
    msgs.forEach(m=>addMessage(m.sender==="user"?"right":"left",m.content));
  }catch(e){ console.error(e); }
},4000);

</script>
</body>
</html>
